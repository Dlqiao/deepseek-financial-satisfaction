# 技术实现细节文档

## 1. 系统架构设计

### 1.1 整体架构
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ 数据采集层 │ → │ 特征工程层 │ → │ 模型服务层 │
├─────────────────┤ ├─────────────────┤ ├─────────────────┤
│ - Tushare API │ │ - 技术指标计算 │ │ - DeepSeek API │
│ - 用户行为日志 │ │ - 基本面因子 │ │ - RAG增强检索 │
│ - 反馈数据收集 │ │ - 情感分析 │ │ - Prompt模板 │
└─────────────────┘ └─────────────────┘ └─────────────────┘
↓ ↓
┌─────────────────┐ ┌─────────────────┐
│ 实验分析层 │ │ 评估反馈层 │
├─────────────────┤ ├─────────────────┤
│ - AB实验平台 │ │ - 满意度预测 │ 
│ - 因果推断 │ │ - 质量评估 │
│ - PSM/DID │ │ - NPS分析 │
└─────────────────┘ └─────────────────┘

### 2. 核心算法实现

#### 2.1 倾向性评分匹配(PSM)算法
```python
# 算法步骤
1. 选择协变量：用户特征、历史行为、查询特征
2. 估计倾向性评分：使用Logistic回归
3. 匹配算法：最近邻匹配（1:1或1:k）
4. 平衡性检验：标准化差异<0.1
5. 处理效应估计：ATT/ATE

#### 2.2 双重差分(DID)模型
Y_it = α + β*Treat_i + γ*Post_t + δ*(Treat_i×Post_t) + ε_it
# δ即为处理效应
3. 数据schema设计

3.1 核心表关系
users ─┬─ user_queries ─┬─ model_responses ─┬─ quality_evaluation
       │                │                    │
       └─ user_feedback  └─ user_experiment_assignments
       
stocks ─── financial_data
4. 特征工程详细说明

4.1 用户特征维度（21个）

基本信息：用户类型、风险偏好、投资经验
行为特征：查询频率、查询深度、反馈历史
兴趣特征：关注行业、关注股票类型
4.2 查询特征维度（15个）

查询类型：分析类、预测类、事实类
股票特征：市值、行业、换手率
时效性：财报季、重大事件
4.3 模型回答特征（18个）

长度特征：token数、段落数
质量特征：数据密度、引用数量
结构特征：分析框架完整度
5. 实验设计方法论

5.1 实验分层

层级	实验类型	流量比例	评估周期
L1	系统层实验	1%	1-2周
L2	策略层实验	5-10%	2-4周
L3	参数层实验	1-5%	1-2周
5.2 实验分组

对照组：基础DeepSeek模型
实验组A：基础RAG增强
实验组B：结构化Prompt
实验组C：RAG+Prompt组合